<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width" />
    <title>Carrier Routes Map</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" integrity="sha256-kLaT2GOSpHechhsozzB+flnD+zUyjE2LlfWPgU04xyI=" crossorigin="" />
    <link rel="stylesheet" href="/map.css" />
    <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js" integrity="sha256-WBkoXOwTeyKclOHuWtc+i2uENFpDZ9YPdf5Hf+D7ewM=" crossorigin=""></script>
    <script src="/leaflet/vendor/Leaflet.fullscreen/Leaflet.fullscreen.js"></script>
    <script src="/leaflet/vendor/Leaflet.TextPath/leaflet.textpath.js"></script>
    <script src="/leaflet/vendor/Leaflet.fullscreen/Leaflet.fullscreen.min.js"></script>
    <script src="/leaflet/controls/L.Control.TemplateButton/L.Control.TemplateButton.js"></script>
    <script src="/leaflet/controls/L.Marker.Classed/L.Marker.Classed.js"></script>
    <script src="/leaflet/L.SVG.groupedPaths.js"></script>
    <!-- Template for Reset View control -->
    <script type="text/html" id="ResetButtonTemplate">
        <div class="leaflet-control-templatebutton leaflet-bar leaflet-control">
            <a class="leaflet-bar-part leaflet-bar-part-single montserrat" title="Reset map to original view" href="#" role="button">
                <span class="leaflet-control-templatebutton-icon fa fa-undo" aria-hidden="true"></span>
            </a>
        </div>
    </script>

</head>
<body>
    <meta name="viewport" content="width=device-width" />
    <div id="map" class="map"></div>

    <script>
    let locale = 'en-US';
    let LMN = L.latLng(42.703772, -84.537131);
    let mapOptions = {
        zoomSnap: 0.5,
        center: LMN,
        zoom: 12
    };

    // Create the map
    var map = L.map("map", mapOptions);

    map.createPane('labels');
    map.getPane('labels').style.zIndex = 550;
    map.getPane('labels').style.pointerEvents = 'none';

    // Tracks data loading requests
    let requests = [];

    // Histogram bins for grouping and summarizing
    let histogram = [
        { minValue: 115000, color:'#800026', group: L.layerGroup(), residences: 0, businesses: 0, routes: 0 },
        { minValue: 100000, color:'#BD0026', group: L.layerGroup(), residences: 0, businesses: 0, routes: 0 },
        { minValue: 85000, color:'#E31A1C', group: L.layerGroup(), residences: 0, businesses: 0, routes: 0 },
        { minValue: 70000, color:'#FC4E2A', group: L.layerGroup(), residences: 0, businesses: 0, routes: 0 },
        { minValue: 55000, color:'#FD8D3C', group: L.layerGroup(), residences: 0, businesses: 0, routes: 0 },
        { minValue: 40000, color:'#FEB24C', group: L.layerGroup(), residences: 0, businesses: 0, routes: 0 },
        { minValue: 25000, color:'#FED976', group: L.layerGroup(), residences: 0, businesses: 0, routes: 0 },
        { minValue: 0, color:'#FFEDA0', group: L.layerGroup(), residences: 0, businesses: 0, routes: 0 },
    ];

    function getColor(m) {
        for (bin of histogram) {
            if (m >= bin.minValue) return bin.color;
        }
    }

    function style(feature) {
        return {
            color: getColor(feature.properties.MED_INCOME),
            weight: 5,
            opacity: 1,
            className: "carrier-route"
        };
    }

    function featureDetail(feature, layer) {
        let props = feature.properties;
        let m = props.MED_INCOME;
        
        let tip = `<h3>${props.ZIP_CRID}</h3><table><tr><th>Med. Income</th><td align='right'>\$${props.MED_INCOME.toLocaleString(locale)}<tr><th>Residences</th><td align='right'>${props.RES_CNT.toLocaleString(locale)}</td></tr><tr><th>Businesses</th><td align='right'>${props.BUS_CNT.toLocaleString(locale)}</td></tr><tr><th>Facility</th><td align='right'>${props.FACILITY_NAME}<tr></table>`;

        layer.options.containerName = "carrier-routes";
        layer.bindTooltip(tip, { permanent: false, sticky: true, direction: 'top' });//.openTooltip();

        // Add layers to group for histogram bin
        for (bin of histogram) {
            if (m >= bin.minValue) {
                bin.residences += feature.properties.RES_CNT;
                bin.businesses += feature.properties.BUS_CNT;
                bin.routes += 1;
                bin.group.addLayer(layer);
                break;
            }
        }

        layer.on('click', featureClick);
    };

    let selectedFeature = null;

    let featureClick = function(e) {
        if (selectedFeature) {
            L.geoJSON().resetStyle(selectedFeature);
        }
        selectedFeature = e.target;
        selectedFeature.bringToFront();
        selectedFeature.setStyle({ className: 'carrier-route-selected', color: 'blue'});
    }

    // Add layers
    // let osmUrl = 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png';
    // let osmAttribution = '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>';
    // L.tileLayer(osmUrl, {
    //     maxZoom: 18,
    //     minZoom: 1,
    //     attribution: osmAttribution
    // }).addTo(map);

    // var CartoDB_PositronNoLabels = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_nolabels/{z}/{x}/{y}{r}.png', {
	// attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
	// subdomains: 'abcd',
	// maxZoom: 20
    // }).addTo(map);

    // var CartoDB_PositronOnlyLabels = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_only_labels/{z}/{x}/{y}{r}.png', {
	// attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
	// subdomains: 'abcd',
    // pane: 'labels',
	// maxZoom: 20
    // }).addTo(map);

    var CartoDB_VoyagerNoLabels = L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager_nolabels/{z}/{x}/{y}{r}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
        subdomains: 'abcd',
        maxZoom: 20
    }).addTo(map);

    var CartoDB_VoyagerOnlyLabels = L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager_only_labels/{z}/{x}/{y}{r}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
        subdomains: 'abcd',
        pane: 'labels',
        maxZoom: 20
    }).addTo(map);

    L.control.fullscreen({
        position: "topleft"
    }).addTo(map);

    L.control.scale({
        position: "bottomright"
    }).addTo(map);

    let lmnMarker = L.marker(LMN, { title: "LMN Headquarters" }).addTo(map);

    let circles = [
        { miles: 20, color: '#afa5e8' },
        { miles: 10, color: '#c0b5ff'},
        { miles: 5, color: '#e9e6ff' },
        { miles: 2, color: '#edc4ff' },
        { miles: 1, color: '#e3a3ff' },
    ];
    for (c of circles) {
        let tip = `${c.miles}-mile radius`;
        L.circle(LMN, c.miles * 1609, { containerName: 'distance-circles', className: 'distance-circle', color: '#333333', fillColor: c.color, fillOpacity: 0, opacity: 0.5, stroke: true, width: 2, dashArray: "1 5"})
        //.bindTooltip(tip, { sticky: true })
        //.setText(tip, { repeat: true })
        .addTo(map);
    }

    let isochrones = [
        { minutes: 10, color: '#222266'},
        { minutes: 20, color: '#662222'},
        { minutes: 30, color: '#226622'},
    ];
    let isochronesGroup = L.layerGroup();
    for (iso of isochrones) {
        url = `/data/isochrone-${iso.minutes}min.geojson`;
        requests.push(
            fetch(url)
            .then(response => response.json())
            .then(data => {
                let layer = L.geoJSON(data, { style:
                    { containerName: 'isochrones',
                      color: iso.color,
                      opacity: 0.75,
                      fillOpacity: 0.05,
                      width: 5,
                      dashArray: "1 3" 
                }});
                layer.bindTooltip(`${iso.minutes}-minute driving distance`, { permanent: false, sticky: true });
                isochronesGroup.addLayer(layer);
            })
            .catch((error) => {
                    console.error(`There was a problem fetching or processing map data for ${url} : `, error);
            })
        );
    }
    isochronesGroup.addTo(map);

    // Add layers control to select histogram bins
    let layerControl = L.control.layers(null, null, { collapsed: false, position: 'bottomright' });
    histogram.map(bin => {
        layerControl.addOverlay(bin.group, `\$${bin.minValue.toLocaleString(locale)}`);
    });
    layerControl.addOverlay(isochronesGroup, 'Isochrones');
    layerControl.addTo(map);

    let zips = [ 48910, 48911, 48933, 48912, 48915, 48842, 48917, 48823, 48906, 48864, 48821, 48840, 48854, 48808, 48820, 48876, 48837, 48895, 48848, 48822, 48827, 48819, 49251, 48872, 48813, 49264, 48892, 48894, 48879, 48875 ];

    zips.forEach ((zip) => {
        url = `/data/routes-${zip}.geojson`;

        requests.push(
            fetch(url)
            .then(response => response.json())
            .then(data => {
                L.geoJSON(data, { style: style, onEachFeature: featureDetail });

                // Add histgram layer groups to map
                for (bin of histogram) {
                    bin.group.addTo(map);
                }

            })
            .catch((error) => {
                console.error(`There was a problem fetching or processing map data for ${url} : `, error);
            }));

    });

    // When all features processed, build a legend
    Promise.all(requests).then(function () {
        // Create legend
        var legend = L.control({ position: "bottomleft" });

        legend.onAdd = function(map) {
            var div = L.DomUtil.create("div", "legend leaflet-control");
            let markup = "<h4>Legend</h4>";
            markup += "<table><tr><th>Income</th><th align='right'>Res.</th><th align='right'>Bus.</th><th align='right'>Routes</tr>";
            for (bin of histogram) {
                markup += `<tr><td align='right'><i style="background: ${bin.color}"></i><span>\$${bin.minValue.toLocaleString(locale)}+</td><td align='right'>${bin.residences.toLocaleString(locale)}</td><td align='right'>${bin.businesses.toLocaleString(locale)}</td><td align='right'>${bin.routes}</td></tr>`;
            }
            markup += "</table>";

            div.innerHTML += markup;
            return div;
        };

        legend.addTo(map);
    });

    </script>

</body>
</html>